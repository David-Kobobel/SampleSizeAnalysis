import pandas as pd
import numpy as np
from scipy.stats import levene
from google.colab import files

uploaded = files.upload()
file_name = list(uploaded.keys())[0]
df = pd.read_excel(file_name)

COL_DISEASE = "Disease Group"
COL_MANUSCRIPT = "Manuscript Sample Size"
COL_SRA = "SRA Sample Size"

def to_numeric_series(s):
    return pd.to_numeric(
        s.astype(str)
         .str.replace(",", "", regex=False)
         .str.strip()
         .replace({"": np.nan, "nan": np.nan, "None": np.nan}),
        errors="coerce"
    )

df = df.copy()
df[COL_MANUSCRIPT] = to_numeric_series(df[COL_MANUSCRIPT])
df[COL_SRA] = to_numeric_series(df[COL_SRA])

df_f = df.dropna(subset=[COL_DISEASE, COL_MANUSCRIPT, COL_SRA]).copy()

MIN_N = 25
counts = df_f[COL_DISEASE].value_counts()
keep_diseases = counts[counts >= MIN_N].index
df_f = df_f[df_f[COL_DISEASE].isin(keep_diseases)].copy()

disease_order = (
    df_f.groupby(COL_DISEASE)[COL_MANUSCRIPT]
        .median()
        .sort_values()
        .index
        .tolist()
)

rows = []

for disease in disease_order:
    sub = df_f[df_f[COL_DISEASE] == disease]

    manuscript = sub[COL_MANUSCRIPT].values
    sra = sub[COL_SRA].values

    var_manuscript = np.var(manuscript, ddof=1)
    var_sra = np.var(sra, ddof=1)

    var_ratio = var_sra / var_manuscript if var_manuscript > 0 else np.nan

    stat, pval = levene(
        sra,
        manuscript,
        center="median"
    )

    rows.append({
        "Disease Group": disease,
        "n (paired)": len(sub),
        "Variance Manuscript": var_manuscript,
        "Variance SRA": var_sra,
        "Variance Ratio (SRA / Manuscript)": var_ratio,
        "Brownâ€“Forsythe stat": stat,
        "p-value": pval
    })

variance_table = (
    pd.DataFrame(rows)
      .sort_values("p-value")
      .reset_index(drop=True)
)

variance_table.to_csv("variance_test_by_disease.csv", index=False)

variance_table
files.download("variance_test_by_disease.csv")

